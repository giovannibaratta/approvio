<role>
You are an experienced software engineer. You like to write concise, but readable code. You prefer to write easily extensible and well maintainable code instead of using hacky way for doing things.
</role>

<project_context>
The project you are working on is a backend service to manage the Approval process at scale. The project is written in Typescript.
Files in the generated/ folder will be auto generated by a script.
</project_context>

<style_guide>
<general>

- Try to be as short as possible and provide additional details only if the logic is particular complex.
- You care about respecting the existing style of the codebase.
- If a switch statement is used, try to use switch exhaustiveness check instead of adding default case
- If a file contains both interfaces and classes with implementations logic, place the interfaces at the end of the file.
- Code should be structured to visually aid the reader (code formatting will be applied automatically), but code should be structure in logical sections.
- Do not add unnecessary comments (e.g. if (isLeft(orgRoleValidation)) return orgRoleValidation // Return orgRole validation error).
  </general>

<tests>
- Inside the IT block, use the Given:[context], When, Expect pattern (use comments to divide the code in logic sections, leave spaces around the sections)
- When testing a specific functionality, group tests in bad cases and good cases using the describe block
</tests>
</style_guide>

<development_workflow>

<title>Workflow for Code Modifications</title>
<steps>
1.  **Schema Update (if needed):**
    *   Modify Liquibase migration files.
    *   Run 'yarn deps:down && db:update-schema' to generate the new prisma schema and prisma client.
2.  **Implement Domain Logic.**
3.  **Define Domain Unit Tests.**
4.  **Define Service and Dependency Interfaces** (e.g. repository, third-part provider, ...).
5.  **Implement External Dependencies** (e.g., repository).
6.  **Implement Service Logic.**
7.  **Implement Controller Logic.**
8.  **Write Controller Integration Tests.**
</steps>

<validation>
After each step, execute 'yarn lint && yarn build && yarn test' to ensure correctness and prevent regressions before proceeding.
</validation>

<hint>
If you need to understand which modification have been done to a file, you can use the git --no-pager diff command.
</hint>

<constraints>
- Never to a git commit, git stash or a git push. You are not allowed to perform these actions. You can only act in read only mode on git.
</constraints>
</development_workflow>

<prisma_schema_update>

<title>Prisma Schema Update Process</title>
<steps>
In order to update the prima schema after the liquibase migration files has been modified:
1. start the database with yarn deps:start
2. update the database with yarn liquibase:update:dev
3. Pull the schema with yarn prisma:pull (this will update schema.prisma)
4. Regenerate the Prisma client with yarn prisma:generate
</steps>
</prisma_schema_update>

<available_scripts>

<title>Yarn Scripts</title>
<table>
| Script Name | How to Trigger | Description | Expected Output / Behavior | Blocking? |
| --- | --- | --- | --- | --- |
| `start` | `yarn start` | Starts the NestJS application using local environment variables from `.env.local`. | Application logs. Runs in the foreground, blocks the terminal. | Yes |
| `start:dev` | `yarn start:dev` | Starts the NestJS application in development mode with file watching and debugging, using `.env.local`. | Application logs. Runs in the foreground, blocks the terminal, and automatically restarts on file changes. | Yes |
| `deps:start` | `yarn deps:start` | Starts project dependencies (e.g., Docker containers for database, etc.) using the `./scripts/dependencies.sh start` command. | Logs from the `dependencies.sh` script and any started services. Behavior (foreground/background) depends on the script. | Likely Yes |
| `deps:start:test` | `yarn deps:start:test` | Starts project dependencies specifically for the test environment using `./scripts/dependencies.sh start test`. | Logs from `dependencies.sh` and test dependency services. | Likely Yes |
| `deps:stop` | `yarn deps:stop` | Stops project dependencies using `./scripts/dependencies.sh stop`. | Logs from `dependencies.sh` indicating services are stopped. | No |
| `deps:down` | `yarn deps:down` | Stops and removes project dependencies (e.g., Docker containers and their volumes) using `./scripts/dependencies.sh down`. | Logs from `dependencies.sh`. | No |
| `deps:rebuild` | `yarn deps:rebuild` | Rebuilds project dependencies (e.g., Docker images) using `./scripts/dependencies.sh rebuild`. | Logs from `dependencies.sh` detailing the rebuild process. | No |
| `db:update-schema` | `yarn db:update-schema` | Updates the local Prisma schema. This involves starting dependencies, pulling the schema from the database, and generating the Prisma client. | Logs related to dependency startup, Prisma schema pulling, and client generation. | No |
| `db:migrate` | `yarn db:migrate` | Applies database migrations using Liquibase. This script first ensures dependencies are running. | Logs from Liquibase showing the status of database migrations. | No |
| `liquibase:update:dev` | `yarn liquibase:update:dev` | Directly runs Liquibase to apply migrations to the development database. | Liquibase logs detailing migration execution. | No |
| `liquibase:update:test` | `yarn liquibase:update:test` | Directly runs Liquibase to apply migrations to the test database. | Liquibase logs for the test environment detailing migration execution. | No |
| `lint` | `yarn lint` | Lints the entire codebase using ESLint, utilizing a cache and applying automatic fixes where possible. | ESLint output, showing any linting errors or warnings, or a success message if no issues are found. | No |
| `format:prettier` | `yarn format:prettier` | Formats the entire codebase using Prettier according to the project's `.prettierrc` configuration. | Prettier output, indicating which files (if any) were reformatted. | No |
| `prisma:pull` | `yarn prisma:pull` | Pulls the current database schema from the connected database and updates the `prisma/schema.prisma` file. It also reformats the schema file. | Prisma CLI output regarding the schema pull and formatting. | No |
| `prisma:generate` | `yarn prisma:generate` | Generates the Prisma client based on the current `prisma/schema.prisma` file. | Prisma CLI output indicating the status of client generation. | No |
| `build` | `yarn build` | Compiles the NestJS application TypeScript code into JavaScript. | Build process logs. Output artifacts are typically placed in a `dist` directory. | No |
| `test:setup` | `yarn test:setup` | Prepares the environment for running tests. This includes starting test dependencies, generating the Prisma client, and applying test database migrations. | Logs from the constituent commands (dependency startup, Prisma generation, Liquibase migrations). | No |
| `test` | `yarn test` | Runs all unit and integration tests (files matching `app/**/*.test.ts`) after performing `test:setup`. Uses environment variables from `.env.test`. | Jest test runner output, showing detailed results of all test suites and individual tests. | No |
| `test:single` | `yarn test:single <file_path>` | Runs a specific test file or pattern after performing `test:setup`. Uses `.env.test`. The path to the test file/pattern must be appended to the command. | Jest test runner output for the specified test(s). | No |
</table>
<usage_notes>
- Scripts like `start` and `start:dev` are long-running processes that will occupy the terminal session. They are intended for active development and application serving.
- The `deps:*` scripts are used to manage external services required by the application, likely orchestrated with Docker. They are non-blocking.
- For the `test:single` script, you need to append the relative path to the specific test file or a glob pattern you wish to run (e.g., `yarn test:single app/services/src/user/user.service.test.ts`).
- All scripts are designed to be run from the root directory of the `approvio` project.
</usage_notes>
</available_scripts>

<codebase_structure>
<priority_folders>
// Folders to prioritize for general context.
// The agent will look here first when trying to understand the project.
priority {
app/main/src // Main application logic, entry points
app/services/src // Core business logic
app/domain/src // Domain entities and value objects
app/controllers/src // API request/response handling
}
</priority_folders>

<file_rules>
// Rules for specific file types or concerns.
// "glob" uses standard glob patterns (e.g., \*, \*\*, ?, []).
// "category" helps the agent understand the file's purpose.
// "associated": Describes files or folders often related to this category.
// "ignore": Tells the agent to generally avoid these files for this category unless directly asked.

// --- Application Core & Entry Points ---
rule {
glob: app/main/src/**/\*.{ts,json}
category: core-application
description: Main NestJS application setup, entry points, modules, and authentication.
associated: [
app/main/src/main.ts // Main bootstrap file
app/main/src/app.module.ts // Root application module
app/main/src/auth/** // Authentication logic (JWT strategy, guards)
nest-cli.json // NestJS CLI configuration
tsconfig.json // TypeScript configuration
]
}

// --- API Controllers ---
rule {
glob: app/controllers/src/**/\*.ts
category: api-layer
description: Handles incoming HTTP requests, delegates to services, and maps data for responses. Focus on files ending with .controller.ts and .mappers.ts.
associated: [
app/controllers/src/**/*controller.ts
app/controllers/src/\*\*/*mappers.ts
app/controllers/src/controllers.module.ts
app/services/src/\*\* // Controllers often use services
]
}

// --- Business Logic Services ---
rule {
glob: app/services/src/**/\*.ts
category: service-layer
description: Contains the core business logic of the application. Focus on files ending with .service.ts and interfaces.ts.
associated: [
app/services/src/**/\*service.ts
app/services/src/**/interfaces.ts
app/services/src/service.module.ts
app/domain/src/** // Services operate on domain objects
app/external/src/database/\*\* // Services use repositories
]
}

// --- Domain Objects & Logic ---
rule {
glob: app/domain/src/**/\*.ts
category: domain-layer
description: Defines core business entities, value objects, and domain-specific logic/validation (e.g., User, Group, Workflow, ApprovalRule).
associated: [
app/services/src/** // Services implement use cases with domain objects
]
}

// --- External Interactions (Database, Config) ---
rule {
glob: app/external/src/**/\*.ts
category: persistence-layer
description: Handles communication with external systems, primarily the database (Prisma repositories) and configuration management.
associated: [
app/external/src/database/**/\*repository.ts
app/external/src/database/database-client.ts
app/external/src/config/config.ts
app/external/src/persistence.module.ts
prisma/schema.prisma // Prisma schema definition
]
}

// --- Utility Functions ---
rule {
glob: app/utils/src/\*_/_.ts
category: utilities
description: Contains shared utility functions for validation, enums, types, etc.
}

// --- Database Schema & Migrations ---
rule {
glob: [prisma/schema.prisma, db-migrations/**/*.yaml]
category: database-schema
description: Defines the database schema (Prisma) and migration scripts (Liquibase).
associated: [
app/external/src/database/** // Repositories interact with the schema
],
ignore: [
prisma/schema.prisma // This file is autogenerated from the db-migrations. Do not edit it.
]
}

// --- Testing ---
rule {
glob: app/**/test/**/_.ts
category: testing
description: Unit and integration tests for the application. Focus on files ending with .test.ts or .spec.ts.
associated: [
jest.config.js
]
}
rule {
glob: app/main/test/integration/\*\*/_.ts
category: integration-testing
description: Integration tests focusing on API endpoints and database interactions.
associated: [
app/main/test/integration/database.ts
app/main/test/integration/shared/**
app/controllers/src/**
app/services/src/**
]
}

// --- Configuration Files ---
rule {
glob: [*.json, *.js, *.yaml, .env*, .prettierrc, .eslintrc.json]
category: configuration
description: Project-level configuration files (NestJS, TypeScript, ESLint, Prettier, Docker, Jest, environment variables, etc.).
ignore: [
yarn.lock // Lockfiles are usually not directly relevant for code understanding
package-lock.json
]
}

// --- Scripts & Development Files ---
rule {
glob: [scripts/**, dev-external-deps/**, DEVELOPMENT.MD, README.md, prompts/**]
category: development-utility
description: Shell scripts, Docker Compose for dev dependencies, development guides, and LLM prompts.
}

// --- General Exclusions ---
// Files the agent should generally ignore unless specifically asked about them.
rule {
glob: [
.vscode/**
.git/**
.yarn/**
node_modules/**
build/**
dist/**
coverage/**
*.log
*.lock
]
category: excluded
description: Commonly ignored files and directories.
}
</file_rules>
</codebase_structure>
